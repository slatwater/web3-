// ==UserScript==
// @name         Auto Click on Shaga Quests SPIN Button in Background
// @namespace    http://tampermonkey.net/
// @version      1.6
// @description  自动点击Shaga Quests页面上的SPIN按钮，并在百度主页上打开Shaga Quests页面，支持后台运行
// @match        *://www.baidu.com/*
// @match        *://glob.shaga.xyz/*quests*
// @grant        GM_openInTab
// @grant        window.focus
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    // 在百度主页上执行，打开Shaga Quests页面
    if (window.location.hostname === 'www.baidu.com') {
        console.log('Detected Baidu, opening Shaga Quests page in a new tab.');
        GM_openInTab('https://glob.shaga.xyz/quests', { active: false, insert: true });
    }

    // 在 Shaga Quests 页面上执行
    if (window.location.hostname === 'glob.shaga.xyz' && window.location.pathname.includes('quests')) {
        console.log('Detected Shaga Quests page.');

        // 定义点击 SPIN 按钮的函数
        function clickSpinButton() {
            const spinButton = document.evaluate('//*[@id="root"]/div/div[1]/main/div[3]/div[2]/div[2]/div[7]', document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
            if (spinButton) {
                console.log('SPIN button found, simulating click...');
                spinButton.click();
                console.log('SPIN button clicked.');
            } else {
                console.log('SPIN button not found, will retry when DOM changes.');
            }
        }

        // 使用 MutationObserver 监听 DOM 变化
        function observeDOMChanges() {
            const targetNode = document.body;
            const config = { childList: true, subtree: true };

            const callback = function(mutationsList, observer) {
                for (let mutation of mutationsList) {
                    if (mutation.type === 'childList') {
                        clickSpinButton();
                    }
                }
            };

            const observer = new MutationObserver(callback);
            observer.observe(targetNode, config);
            console.log('Observing DOM changes for SPIN button...');
        }

        // 页面加载完成后的操作
        window.addEventListener('load', () => {
            console.log('Page loaded, starting SPIN button check...');
            setTimeout(() => {
                clickSpinButton();     // 立即尝试点击
                observeDOMChanges();   // 开始监听 DOM 变化
            }, 2000); // 页面加载完成后延迟2秒后开始
        });
    }
})();
