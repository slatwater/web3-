// ==UserScript==
// @name         Auto Click on Arcana P12 Tasks (Simplified Clicks)
// @namespace    http://tampermonkey.net/
// @version      1.3
// @description  自动点击 Arcana P12 页面上的多个指定元素，并处理弹窗和页面交互
// @match        *://www.baidu.com/*
// @match        *://arcana.p12.games/*
// @grant        GM_openInTab
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    // 随机延迟函数，避免被检测为机器人
    function randomDelay(min, max) {
        return new Promise(resolve => setTimeout(resolve, Math.floor(Math.random() * (max - min + 1)) + min));
    }

    // 等待元素出现的函数
    function waitForElement(selector, timeout = 15000) {
        return new Promise((resolve, reject) => {
            const startTime = Date.now();
            (function check() {
                const element = document.querySelector(selector);
                if (element) {
                    resolve(element);
                } else if (Date.now() - startTime > timeout) {
                    reject(new Error(`Timeout: Element ${selector} not found`));
                } else {
                    requestAnimationFrame(check);
                }
            })();
        });
    }

    // 直接使用 HTMLElement 的 click 方法模拟点击
    function safeClick(element) {
        if (element) {
            element.click();
            console.log('Element clicked:', element);
        } else {
            console.error('Element not found to click.');
        }
    }

    // 查找并点击文本为 "Featured" 的按钮
    async function clickFeaturedButton() {
        const divs = document.querySelectorAll('div'); // 获取所有 div 元素
        for (let div of divs) {
            if (div.innerText.includes("Featured")) { // 检查 div 文本
                console.log('找到 "Featured" 元素，模拟点击...');
                safeClick(div);  // 使用安全点击方式
                return;
            }
        }
        throw new Error('未找到 "Featured" 按钮');
    }

    // 点击第一个区域
    async function clickFirstArea() {
        const areaSelector = '#__next > div > div.relative.h-full.__className_e04c4e.__variable_e04c4e > main > div > div.grid.w-full.grid-cols-3.gap-4.overflow-auto.px-15.pb-6.pt-4.\\32 xl\\:container.xl\\:px-4 > div.col-span-2.flex.w-full.gap-5 > div.guide-step-01.backdrop-box.flex.w-\\[480px\\].cursor-pointer.flex-col.overflow-hidden.rounded-lg.pb-4.transition-all.lg\\:flex-grow';
        const firstArea = await waitForElement(areaSelector);
        safeClick(firstArea);
        console.log('点击第一个区域');
        await randomDelay(1000, 3000);
    }

    // 在第二个弹窗内点击 "Max" 按钮，并依次点击其他元素
    async function handleSecondPopup() {
        const maxButton = await waitForElement('button:contains("Max")');
        safeClick(maxButton);
        console.log('点击 Max 按钮');
        await randomDelay(1000, 3000);

        // 点击指定元素
        const secondElement = await waitForElement('//*[@id=":r1j:"]/div/div[2]/div[4]/button');
        safeClick(secondElement);
        console.log('点击第二个元素');
        await randomDelay(1000, 3000);

        // 点击关闭弹窗的元素
        const closeElement = await waitForElement('//*[@id=":r1j:"]/div/div[1]/svg');
        safeClick(closeElement);
        console.log('点击关闭按钮');
        await randomDelay(1000, 3000);
    }

    // 返回第一个弹窗并点击指定元素
    async function returnToFirstPopup() {
        const closeIcon = await waitForElement('//*[@id=":r11:"]/div/div/div[1]/svg/line[2]');
        safeClick(closeIcon);
        console.log('关闭第一个弹窗');
        await randomDelay(1000, 3000);
    }

    // 点击任务页上的 "Task" 和 "Verify" 按钮
    async function clickTaskAndVerify() {
        const taskButton = await waitForElement('//*[@id="task"]');
        safeClick(taskButton);
        console.log('点击 Task 按钮');
        await randomDelay(1000, 3000);

        const verifyButton = await waitForElement('button:contains("Verify")');
        safeClick(verifyButton);
        console.log('点击 Verify 按钮');
    }

    // 在百度主页打开新标签并重定向到 Arcana P12 页面
    if (window.location.hostname === 'www.baidu.com') {
        console.log('Detected Baidu, opening Arcana P12 page in a new tab.');
        GM_openInTab('https://arcana.p12.games/', { active: true, insert: true });
    }

    // 在 Arcana P12 页面执行自动化操作
    if (window.location.hostname === 'arcana.p12.games') {
        window.addEventListener('load', async () => {
            console.log('Page loaded, starting automation process...');
            await randomDelay(3000, 5000); // 页面加载后的延迟

            try {
                await clickFirstArea();  // 点击第一个区域
                await clickFeaturedButton();  // 在第一个弹窗内点击 Featured 按钮
                await handleSecondPopup();  // 在第二个弹窗内点击 Max 按钮和其他元素
                await returnToFirstPopup();  // 返回第一个弹窗并点击关闭按钮
                await clickTaskAndVerify();  // 点击任务页的 Task 和 Verify 按钮
            } catch (error) {
                console.error('自动化过程出错：', error);
            }
        });
    }
})();
