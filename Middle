// ==UserScript==
// @name         Midle Airdrops LiveArt è‡ªåŠ¨åŒ–è„šæœ¬
// @namespace    http://tampermonkey.net/
// @version      1.5.0
// @description  è‡ªåŠ¨åŒ–æ“ä½œ https://app.midle.io/airdrops/liveart é¡µé¢ä¸Šçš„æŒ‰é’®ç‚¹å‡»
// @author       æ‚¨çš„åå­—
// @match        https://app.midle.io/airdrops/liveart
// @icon         https://www.google.com/s2/favicons?sz=64&domain=midle.io
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // ç‰ˆæœ¬æ ‡è®°
    const SCRIPT_VERSION = '1.5.0';

    // éšæœºå»¶è¿Ÿå‡½æ•°ï¼ˆæ¯«ç§’ï¼‰
    function randomDelay(min, max) {
        const delay = Math.floor(Math.random() * (max - min + 1)) + min;
        return new Promise(resolve => setTimeout(resolve, delay));
    }

    // æ ¹æ®é€‰æ‹©å™¨èŽ·å–å…ƒç´ 
    function getElementBySelector(selector, context = document) {
        return context.querySelector(selector);
    }

    // ç‚¹å‡»å…ƒç´ å¹¶è¿”å›žæ˜¯å¦æˆåŠŸ
    async function clickElement(element, description) {
        if (element) {
            try {
                element.click();
                console.log(`âœ”ï¸ æˆåŠŸç‚¹å‡» ${description}`);
                return true;
            } catch (error) {
                console.error(`âŒ ç‚¹å‡» ${description} å¤±è´¥:`, error);
                return false;
            }
        } else {
            console.warn(`âš ï¸ ${description} ä¸å­˜åœ¨`);
            return false;
        }
    }

    // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
    async function waitForPageLoad() {
        return new Promise((resolve) => {
            if (document.readyState === 'complete') {
                resolve();
            } else {
                window.addEventListener('load', () => resolve());
            }
        });
    }

    // ä¸»å‡½æ•°
    async function main() {
        console.log(`ðŸ”§ Tampermonkeyè„šæœ¬ç‰ˆæœ¬ ${SCRIPT_VERSION} å·²å¯åŠ¨`);

        // ç­‰å¾…é¡µé¢åŠ è½½
        await waitForPageLoad();
        console.log('âœ… é¡µé¢å·²å®Œå…¨åŠ è½½');

        // éšæœºå»¶è¿Ÿ 1-3 ç§’åŽå¼€å§‹æ‰§è¡Œ
        const initialDelay = Math.floor(Math.random() * 3000) + 3000;
        console.log(`â³ ç­‰å¾… ${initialDelay} æ¯«ç§’åŽå¼€å§‹æ‰§è¡Œè„šæœ¬`);
        await randomDelay(initialDelay, initialDelay);

        // ç¬¬äºŒæ­¥ï¼šéåŽ†åŒºåŸŸ1ä¸­çš„æŒ‰é’®å¹¶ç‚¹å‡»
        const area1Selector = '#system_layout_main > div > main > div > div.px-3 > div:nth-child(3) > div';
        const area1 = getElementBySelector(area1Selector);

        if (area1) {
            console.log('ðŸ” æ‰¾åˆ°åŒºåŸŸ1ï¼Œå‡†å¤‡éåŽ†æŒ‰é’®');
            let buttons = Array.from(area1.querySelectorAll('button'));
            while (buttons.length > 0) {
                for (let i = 0; i < buttons.length; i++) {
                    let button = buttons[i];
                    if (!button) continue;

                    console.log(`ðŸ”˜ æ­£åœ¨ç‚¹å‡»ç¬¬ ${i + 1} ä¸ªæŒ‰é’®`);
                    let clickSuccess = false;
                    for (let attempt = 1; attempt <= 3; attempt++) {
                        button.click();
                        console.log(`âœ”ï¸ ç¬¬ ${attempt} æ¬¡å°è¯•ç‚¹å‡»æŒ‰é’®`);
                        await randomDelay(3000, 4000); // éšæœºå»¶è¿Ÿ 3-4 ç§’

                        // æ£€æŸ¥æŒ‰é’®æ˜¯å¦å·²æ¶ˆå¤±
                        if (!area1.contains(button)) {
                            console.log('âœ… æŒ‰é’®å·²æ¶ˆå¤±ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªæŒ‰é’®');
                            clickSuccess = true;
                            break;
                        } else {
                            console.warn(`âš ï¸ æŒ‰é’®æœªæ¶ˆå¤±ï¼Œå‡†å¤‡ç¬¬ ${attempt + 1} æ¬¡å°è¯•`);
                        }
                    }

                    if (!clickSuccess) {
                        console.error('âŒ ç‚¹å‡»æŒ‰é’®å¤±è´¥ 3 æ¬¡ï¼Œè·³è¿‡æ­¤æŒ‰é’®');
                    }

                    // æ›´æ–°æŒ‰é’®åˆ—è¡¨
                    buttons = Array.from(area1.querySelectorAll('button'));
                }
            }
            console.log('ðŸŽ‰ æ‰€æœ‰æŒ‰é’®å·²å¤„ç†å®Œæ¯•ï¼Œè„šæœ¬æ‰§è¡Œç»“æŸ');
        } else {
            console.error('âŒ æœªæ‰¾åˆ°åŒºåŸŸ1ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œç¬¬äºŒæ­¥');
        }
    }

    // æ‰§è¡Œä¸»å‡½æ•°
    main();

})();
