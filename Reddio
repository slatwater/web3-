// ==UserScript==
// @name         Reddio Points Task è‡ªåŠ¨åŒ–è„šæœ¬
// @namespace    http://tampermonkey.net/
// @version      1.0.0
// @description  è‡ªåŠ¨ç‚¹å‡» https://points.reddio.com/task é¡µé¢ä¸Šçš„æŒ‡å®šæŒ‰é’®
// @author       æ‚¨çš„åå­—
// @match        https://points.reddio.com/task
// @icon         https://www.google.com/s2/favicons?sz=64&domain=reddio.com
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // ç‰ˆæœ¬æ ‡è®°
    const SCRIPT_VERSION = '1.0.0';

    /**
     * ç”Ÿæˆä¸€ä¸ªä»‹äº min å’Œ max æ¯«ç§’ä¹‹é—´çš„éšæœºå»¶è¿Ÿ
     * @param {number} min æœ€å°å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
     * @param {number} max æœ€å¤§å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
     * @returns {Promise} å»¶è¿Ÿå®Œæˆçš„Promise
     */
    function randomDelay(min, max) {
        const delay = Math.floor(Math.random() * (max - min + 1)) + min;
        return new Promise(resolve => setTimeout(resolve, delay));
    }

    /**
     * é€šè¿‡XPathè·å–å…ƒç´ 
     * @param {string} xpath å…ƒç´ çš„XPathè·¯å¾„
     * @returns {HTMLElement|null} è¿”å›æ‰¾åˆ°çš„å…ƒç´ æˆ–null
     */
    function getElementByXPath(xpath) {
        return document.evaluate(xpath, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
    }

    /**
     * ç‚¹å‡»æŒ‡å®šçš„å…ƒç´ å¹¶è®°å½•æ—¥å¿—
     * @param {HTMLElement} element è¦ç‚¹å‡»çš„å…ƒç´ 
     * @param {string} description å…ƒç´ çš„æè¿°ä¿¡æ¯
     * @returns {Promise<boolean>} è¿”å›ç‚¹å‡»æ˜¯å¦æˆåŠŸ
     */
    async function clickElement(element, description) {
        if (element) {
            try {
                element.click();
                console.log(`âœ”ï¸ æˆåŠŸç‚¹å‡» ${description}`);
                return true;
            } catch (error) {
                console.error(`âŒ ç‚¹å‡» ${description} å¤±è´¥:`, error);
                return false;
            }
        } else {
            console.warn(`âš ï¸ ${description} ä¸å­˜åœ¨`);
            return false;
        }
    }

    /**
     * ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
     * @returns {Promise} é¡µé¢åŠ è½½å®Œæˆçš„Promise
     */
    async function waitForPageLoad() {
        return new Promise((resolve) => {
            if (document.readyState === 'complete') {
                resolve();
            } else {
                window.addEventListener('load', () => resolve());
            }
        });
    }

    /**
     * ä¸»å‡½æ•°ï¼Œæ‰§è¡Œè‡ªåŠ¨ç‚¹å‡»æ“ä½œ
     */
    async function main() {
        console.log(`ğŸ”§ Tampermonkeyè„šæœ¬ç‰ˆæœ¬ ${SCRIPT_VERSION} å·²å¯åŠ¨`);

        // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
        await waitForPageLoad();
        console.log('âœ… é¡µé¢å·²å®Œå…¨åŠ è½½');

        // éšæœºå»¶è¿Ÿ1-3ç§’åå¼€å§‹æ‰§è¡Œ
        const initialDelay = Math.floor(Math.random() * 2000) + 1000;
        console.log(`â³ ç­‰å¾… ${initialDelay} æ¯«ç§’åå¼€å§‹æ‰§è¡Œè„šæœ¬`);
        await randomDelay(initialDelay, initialDelay);

        // å®šä¹‰å…ƒç´ 1çš„XPath
        const element1XPath = '/html/body/div[1]/main/div/div[8]/div/div[2]/div[1]/button';
        const element1 = getElementByXPath(element1XPath);

        if (element1) {
            console.log('ğŸ” æ‰¾åˆ°å…ƒç´ 1ï¼Œå‡†å¤‡ç‚¹å‡»');
            const clicked = await clickElement(element1, 'å…ƒç´ 1');
            if (clicked) {
                console.log('ğŸ‰ å…ƒç´ 1å·²æˆåŠŸç‚¹å‡»ï¼Œè„šæœ¬æ‰§è¡Œç»“æŸ');
            }
        } else {
            console.error('âŒ æœªæ‰¾åˆ°å…ƒç´ 1ï¼Œè„šæœ¬æ‰§è¡Œç»“æŸ');
        }
    }

    // æ‰§è¡Œä¸»å‡½æ•°
    main();

})();
